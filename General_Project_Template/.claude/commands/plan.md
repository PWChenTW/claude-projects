---
name: plan
description: 計畫階段 - 制定詳細的實施計畫和技術方案
---

# 計畫命令 (Plan Command)

## 命令用途

`/plan [功能名稱]` - 基於探索結果，制定詳細、可執行的實施計畫。

## 核心理念

> "A goal without a plan is just a wish" - 沒有計畫的目標只是願望

好的計畫可以減少 80% 的返工，讓執行階段順暢無阻。

## 觸發時機

### 自動觸發
- 完成 `/explore` 後自動建議
- `/spec-init` 流程的第二階段
- 當用戶說"我們來計畫一下"

### 手動觸發
```bash
/plan authentication-refactor  # 計畫認證重構
/plan new-payment-feature     # 計畫新支付功能
/plan bug-fix-strategy        # 計畫錯誤修復策略
```

## 工作流程

### 階段 1：需求確認 (5 分鐘)
```bash
1. 回顧探索發現
   - 讀取探索報告
   - 確認理解正確
   - 澄清模糊點

2. 明確目標
   - 功能需求
   - 非功能需求
   - 成功標準

3. 確認約束
   - 時間限制
   - 技術限制
   - 資源限制
```

### 階段 2：方案設計 (10-15 分鐘)
```bash
1. 技術方案制定
   - 架構設計
   - 技術選型
   - 介面定義

2. 任務分解
   - 拆分為可管理的子任務
   - 定義任務依賴
   - 估算工作量

3. 風險規劃
   - 識別技術風險
   - 制定應對策略
   - 準備 Plan B
```

### 階段 3：執行規劃 (5 分鐘)
```bash
1. 執行順序
   - 優先級排序
   - 里程碑設定
   - 檢查點定義

2. 測試策略
   - 單元測試計畫
   - 整合測試計畫
   - 驗收標準

3. 回滾計畫
   - 回滾條件
   - 回滾步驟
   - 資料備份
```

## 計畫技巧

### 有效的任務分解
```markdown
❌ 錯誤：實作用戶認證
✅ 正確：
   1. 設計資料庫 schema (30min)
   2. 實作註冊 API (45min)
   3. 實作登入 API (45min)
   4. 添加 JWT 驗證 (30min)
   5. 編寫單元測試 (60min)
   6. 更新文檔 (30min)
```

### 風險評估矩陣
```markdown
| 風險 | 可能性 | 影響 | 優先級 | 緩解措施 |
|------|--------|------|--------|----------|
| 資料庫遷移失敗 | 中 | 高 | P1 | 準備回滾腳本 |
| API 效能問題 | 低 | 中 | P2 | 實施快取策略 |
| 第三方服務中斷 | 低 | 高 | P1 | 實作降級方案 |
```

## 輸出格式

### 實施計畫模板
```markdown
# [功能名稱] 實施計畫
日期：[YYYY-MM-DD]
預計工時：[X 小時]

## 目標概述
### 功能目標
- 目標 1: [描述]
- 目標 2: [描述]

### 成功標準
- [ ] 標準 1
- [ ] 標準 2
- [ ] 標準 3

## 技術方案
### 架構設計
```
[架構圖或描述]
```

### 技術棧
- 語言/框架: [選擇和理由]
- 資料庫: [選擇和理由]
- 第三方服務: [選擇和理由]

## 任務分解
### Phase 1: 基礎建設 (預計 2 小時)
- [ ] Task 1.1: 建立資料模型 (30min)
  - 設計 schema
  - 建立 migration
- [ ] Task 1.2: 設定基礎架構 (30min)
  - 配置環境
  - 設定依賴
- [ ] Task 1.3: 建立專案結構 (60min)
  - 建立目錄結構
  - 初始化模組

### Phase 2: 核心功能 (預計 4 小時)
- [ ] Task 2.1: 實作業務邏輯 (120min)
  - 子任務 A
  - 子任務 B
- [ ] Task 2.2: 實作 API 層 (120min)
  - 端點設計
  - 請求處理

### Phase 3: 測試和優化 (預計 2 小時)
- [ ] Task 3.1: 單元測試 (60min)
- [ ] Task 3.2: 整合測試 (30min)
- [ ] Task 3.3: 效能優化 (30min)

## 風險管理
### 已識別風險
1. **風險 A**: [描述]
   - 影響: [高/中/低]
   - 緩解: [策略]

2. **風險 B**: [描述]
   - 影響: [高/中/低]
   - 緩解: [策略]

### 應急計畫
- Scenario A: [應對方案]
- Scenario B: [應對方案]

## 測試策略
### 測試範圍
- 單元測試: [覆蓋目標]
- 整合測試: [測試場景]
- E2E 測試: [關鍵路徑]

### 驗收標準
- [ ] 功能測試全部通過
- [ ] 代碼覆蓋率 > X%
- [ ] 性能指標達標
- [ ] 安全檢查通過

## 實施時間表
```
Day 1: Phase 1 完成
Day 2: Phase 2 (Task 2.1)
Day 3: Phase 2 (Task 2.2)
Day 4: Phase 3 + 部署
```

## 依賴和前置條件
- [ ] 依賴 1: [描述和負責人]
- [ ] 依賴 2: [描述和負責人]
- [ ] 前置條件 1: [描述]

## 關鍵決策點
- Decision 1: [時間點和標準]
- Decision 2: [時間點和標準]

## 溝通計畫
- 日常同步: [頻率和方式]
- 進度報告: [頻率和接收者]
- 問題升級: [流程]
```

## 輸出位置

計畫文檔保存到：
- `.kiro/specs/[feature]/plan.md` - 詳細計畫文檔
- `.kiro/specs/[feature]/tasks.md` - 任務清單
- `.kiro/context/current-plan.md` - 當前執行計畫

## 與其他命令的關係

```mermaid
graph LR
    A[/explore] --> B[/plan]
    B --> C[/execute]
    C --> D[/verify]
    B --> E[/estimate]
    B --> F[/risk-assess]
```

- **前置命令**: 需要先執行 `/explore`
- **後續命令**: 完成後執行 `/execute`
- **輔助命令**: 可配合 `/estimate` 和 `/risk-assess`

## 計畫原則

### MVP 優先
```markdown
1. 先實作核心功能
2. 後添加附加功能
3. 最後優化效能
```

### 迭代式規劃
```markdown
- Version 1.0: 基本功能 (必須)
- Version 1.1: 增強功能 (應該)
- Version 2.0: 進階功能 (可以)
```

### 風險驅動
```markdown
1. 優先解決高風險項目
2. 早期驗證關鍵假設
3. 保持計畫彈性
```

## 成功指標

一個好的計畫應該：
- ✅ 任務清晰可執行
- ✅ 時間估算合理
- ✅ 風險已識別和規劃
- ✅ 有明確的驗收標準
- ✅ 考慮了依賴和約束

## 注意事項

### ⚠️ 避免的陷阱
- 過度規劃（分析癱瘓）
- 忽略風險評估
- 任務粒度太大
- 沒有 Plan B

### 💡 最佳實踐
- 保持任務在 2 小時內
- 預留 20% 緩衝時間
- 定義清晰的完成標準
- 及時更新計畫

## 範例使用

### 場景 1：新功能計畫
```bash
User: 我們來計畫支付功能的實作
Assistant: 基於之前的探索，讓我制定詳細計畫...

/plan payment-integration

[分析需求]
[設計方案]
[分解任務]

計畫完成！預計需要 16 小時，分為 4 個階段：
1. 支付網關整合 (4h)
2. 訂單處理流程 (6h)
3. 退款機制 (3h)
4. 測試和文檔 (3h)

是否要查看詳細任務分解？
```

### 場景 2：重構計畫
```bash
User: 認證系統需要重構
Assistant: 讓我制定一個安全的重構計畫...

/plan auth-refactoring

[評估現狀]
[設計新架構]
[制定遷移策略]

重構計畫制定完成，採用漸進式策略：
- 第一週：新建平行系統
- 第二週：逐步遷移
- 第三週：切換和清理

每個階段都有回滾點，確保安全。
```

## 配置選項

在 `.claude/settings.json` 中配置：
```json
{
  "plan": {
    "template": "detailed",
    "estimate_buffer": 1.2,
    "risk_threshold": "medium",
    "task_max_hours": 2,
    "require_tests": true
  }
}
```

---

記住：**好的計畫是成功的一半**。寧可在計畫上多花時間，也不要在執行中不斷返工。